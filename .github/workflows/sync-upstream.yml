name: Sync Fork with Upstream

on:
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨执行同步，可以根据需要调整时间
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout your repository
      uses: actions/checkout@v2
      with:
        persist-credentials: false

    - name: Add upstream repository
      run: git remote add upstream https://github.com/King-Of-Knights/openwrt-6.x.git

    - name: Fetch upstream
      run: git fetch upstream

    - name: Check for new commits
      id: check
      run: |
        # 获取当前分支的最新提交哈希值
        CURRENT_HASH=$(git rev-parse HEAD)
        # 获取上游分支的最新提交哈希值
        UPSTREAM_HASH=$(git rev-parse upstream/main)
        # 检查是否有新提交
        if [ "$CURRENT_HASH" != "$UPSTREAM_HASH" ]; then
          echo "New commits are available."
          echo "::set-output name=new_commits::true"
        else
          echo "No new commits."
          echo "::set-output name=new_commits::false"
        fi

    - name: Merge upstream changes
      if: steps.check.outputs.new_commits == 'true'
      run: |
        git merge upstream/main --allow-unrelated-histories # 如果使用不同的分支名称，请调整

    - name: Push changes to fork repository
      if: steps.check.outputs.new_commits == 'true'
      run: |
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
